{% extends "base.html" %}

{% block title %}Chat - ReGen{% endblock %}

{% block content %}
<div class="px-4">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">Chat with ReGen</h1>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-4" style="height: 500px; overflow-y: auto;" id="chatMessages">
            <div class="p-6 space-y-4">
                <div class="flex items-start">
                    <div class="bg-blue-100 rounded-lg p-4 max-w-xl">
                        <p class="text-sm text-gray-800">Hello! I'm ReGen, your AI assistant for navigating federal systems and resources. How can I help you today?</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <form id="chatForm" class="flex gap-2">
                <input
                    type="text"
                    id="messageInput"
                    placeholder="Type your message..."
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                />
                <button
                    type="submit"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition disabled:bg-gray-400"
                    id="sendButton"
                >
                    Send
                </button>
            </form>
        </div>

        <div class="mt-4 flex gap-2">
            <button
                id="ttsButton"
                class="text-sm bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition disabled:bg-gray-300"
                disabled
            >
                ðŸ”Š Read Last Message
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let lastAiMessage = '';
    let selectedLanguage = localStorage.getItem('selectedLanguage') || 'en';

    document.getElementById('chatForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const chatMessages = document.getElementById('chatMessages');
        const message = messageInput.value.trim();

        if (!message) return;

        selectedLanguage = localStorage.getItem('selectedLanguage') || 'en';

        sendButton.disabled = true;
        sendButton.textContent = 'Sending...';

        const userMessageDiv = document.createElement('div');
        userMessageDiv.className = 'flex items-start justify-end p-3';
        userMessageDiv.innerHTML = `
            <div class="bg-blue-600 text-white rounded-lg p-4 max-w-xl">
                <p class="text-sm">${escapeHtml(message)}</p>
            </div>
        `;
        chatMessages.querySelector('.space-y-4').appendChild(userMessageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        messageInput.value = '';

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message, language: selectedLanguage }),
            });

            const data = await response.json();

            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.className = 'flex items-start p-3';
            aiMessageDiv.innerHTML = `
                <div class="bg-blue-100 rounded-lg p-4 max-w-xl">
                    <p class="text-sm text-gray-800">${escapeHtml(data.response || data.message || 'I received your message.')}</p>
                </div>
            `;
            chatMessages.querySelector('.space-y-4').appendChild(aiMessageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            lastAiMessage = data.response || data.message || '';
            document.getElementById('ttsButton').disabled = false;
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to send message. Please try again.');
        } finally {
            sendButton.disabled = false;
            sendButton.textContent = 'Send';
        }
    });

    document.getElementById('ttsButton').addEventListener('click', async () => {
        if (!lastAiMessage) return;

        const ttsButton = document.getElementById('ttsButton');
        ttsButton.disabled = true;
        ttsButton.textContent = 'ðŸ”Š Processing...';

        selectedLanguage = localStorage.getItem('selectedLanguage') || 'en';

        const languageVoiceMap = {
            'en': 'en-US',
            'es': 'es-ES',
            'zh': 'zh-CN',
            'ar': 'ar-SA',
            'fr': 'fr-FR',
            'ru': 'ru-RU',
            'pt': 'pt-BR',
            'hi': 'hi-IN'
        };

        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(lastAiMessage);
            utterance.lang = languageVoiceMap[selectedLanguage] || 'en-US';
            utterance.rate = 0.9;
            utterance.pitch = 1;

            utterance.onend = () => {
                ttsButton.disabled = false;
                ttsButton.textContent = 'ðŸ”Š Read Last Message';
            };

            utterance.onerror = (error) => {
                console.error('Speech synthesis error:', error);
                ttsButton.disabled = false;
                ttsButton.textContent = 'ðŸ”Š Read Last Message';
            };

            window.speechSynthesis.speak(utterance);
        } else {
            alert('Text-to-speech is not supported in your browser.');
            ttsButton.disabled = false;
            ttsButton.textContent = 'ðŸ”Š Read Last Message';
        }
    });

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
</script>
{% endblock %}
